---
layout: post
title: 'Recipe: Detect whether cookies are enabled in rails'
date: 2009-09-29 19:18:44.000000000 -07:00
categories:
- Ruby/Rails
tags: []
status: publish
type: post
published: true
meta:
  _syntaxhighlighter_encoded: '1'
  _edit_last: '1'
  other_media: ''
  main_video: ''
author:
  login: jhund
  email: jhund@clearcove.ca
  display_name: jhund
  first_name: ''
  last_name: ''
excerpt: !ruby/object:Hpricot::Doc
  options: {}
---
<p>If your Rails app requires cookies, this recipe is for you: It detects whether cookies are enabled, and if not, shows a message to your users.</p>
<p> <!--more--></p>
<p>This recipe checks for the presence of a specific cookie ("cookie_test"). If it is present, the request continues normally. If it is not present, then it sets the cookie, redirects to the "cookie_test" action and checks there whether the cookie is present. If the cookie is present, then everything continues on normally. If the cookie is still not present, then this is a strong indication that the user has cookies disabled. Then the recipe shows a page to the user explaining the cookie requirement. I leave it up to you to write the copy for that page.</p>
<p>[caption id="attachment_419" align="alignnone" width="348" caption="Flow chart for the cookie detection recipe"]<img src="assets/CookieDetectionFlowChart.png" alt="Flow chart for the cookie detection recipe" title="CookieDetectionFlowChart" width="348" height="460" class="size-full wp-image-419" />[/caption]</p>
<p>This recipe works as of Rails 2.3 (new cookie handling). It is inspired by this <a href="http://kill-0.com/duplo/2007/07/12/rails-cookie-detection/">article</a>. The recipe in the original article does not work with newer versions of rails. So I updated it and packaged it up in a neat little module that you can include in your application controller.</p>
<h2>How to use it</h2>
<ol>
<li>save this file at a location in your rails app where it gets required (e.g. RAILS_ROOT/lib/cookie_detection.rb)</li>
<li>In application_controller.rb:<br />
Include CookieDetection (at the top to make this the first before_filter)</li>
<li>In routes.rb:<br />
map.cookies_test "cookie_test", :controller => "application", :action => "cookie_test"</li>
<li>In RAILS_ROOT/views/shared/cookies_required.html.erb:<br />
Display a message that lets your users know of the cookie requirement.</li>
</ol>
<p>[ruby]<br />
# RAILS_ROOT/lib/cookie_detection.rb</p>
<p># Detects if cookies are present.<br />
# If cookies are disabled, shows view located at shared/cookies_required<br />
# Usage:<br />
# * save this file at a location in your rails app where it gets required<br />
#   (e.g. RAILS_ROOT/lib)<br />
# * application_controller:<br />
#   Include CookieDetection (at the top to make this the first before_filter)<br />
# * routes.rb:<br />
#   map.cookies_test &quot;cookie_test&quot;, :controller =&gt; &quot;application&quot;, :action =&gt; &quot;cookie_test&quot;<br />
# * views/shared/cookies_required.html.erb:<br />
#   Display a message that lets your users know of the cookie requirement.<br />
module CookieDetection</p>
<p>  def self.included(base)<br />
    base.before_filter :cookies_required, :except =&gt; [&quot;cookie_test&quot;]<br />
  end</p>
<p>  # checks for presence of &quot;cookie_test&quot; cookie<br />
  # (should have been set by cookies_required before_filter)<br />
  # if cookie is present, continue normal operation<br />
  # otherwise show cookie warning at &quot;shared/cookies_required&quot;<br />
  def cookie_test<br />
    if cookies[&quot;cookie_test&quot;].blank?<br />
      logger.warn(&quot;=== cookies are disabled&quot;)<br />
      render :template =&gt; &quot;shared/cookies_required&quot;, :layout =&gt; &quot;system&quot;<br />
    else<br />
      redirect_back_or_default(dashboard_path)<br />
    end<br />
  end</p>
<p>protected</p>
<p>  # checks for presence of &quot;cookie_test&quot; cookie.<br />
  # If not present, redirects to cookies_test action<br />
  def cookies_required<br />
    return true unless cookies[&quot;cookie_test&quot;].blank?<br />
    cookies[&quot;cookie_test&quot;] = Time.now<br />
    session[:return_to] = request.request_uri<br />
    redirect_to(cookies_test_path)<br />
  end</p>
<p>end<br />
[/ruby]</p>

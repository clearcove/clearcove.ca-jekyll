---
layout: post
title: 'Recipe: Make request environment available to models in Rails'
date: 2008-08-31 12:50:41.000000000 -07:00
categories:
- Ruby/Rails
tags:
- broadcast
status: publish
type: post
published: true
meta:
  _edit_last: '1'
author:
  login: jhund
  email: jhund@clearcove.ca
  display_name: jhund
  first_name: ''
  last_name: ''
excerpt: !ruby/object:Hpricot::Doc
  options: {}
---
<p>How often do you wish you had access to current_user in one of your models? I needed it for an app that required auditing. I had ActiveRecord call backs on the audited models to create audit entries on every record operation. The problem was that the models had no access to the currently logged in user. <!--more--></p>
<h2>Objective</h2>
<p>To store web request environment parameters accessibly everywhere in my Rails app. Examples:</p>
<ul>
<li>the current user needs to be accessible to my Models to implement an audit trail via Active Record callbacks.</li>
<li>I want to store the current time zone so that it can be used by the various parts of my app (This is actually what Rails does for TimeZone support).</li>
</ul>
<p>You might say "Auditing can be done in the controller". True, however I find it much more elegant to put it into the models. So how did I do it? I used ActiveRecord call backs on creating, updating, and deleting records. I stored the current user in a way that the models can access it. The same way Rails stores the current time zone for a request: In the current thread. Check out the <a href="http://github.com/rails/rails/tree/master/activesupport/lib/active_support/core_ext/time/zones.rb">rails source for details how it is done there.</a></p>
<h2>Summary</h2>
<ul>
<li>implement accessors for 'current' on each class that is a request environment parameter. In this example I implement User.current</li>
<li>set the variable via the accessors in an application_controller before_filter</li>
<li>accessors store current request parameters in Thread.current[:parameter_name]</li>
</ul>
<p>Please see <a href="http://github.com/jhund/rails-recipes/tree/master">github</a> for the code for this and my other recipes.</p>
<p>Here is the code to store a variable in the current thread so that it is accessible everywhere in the Rails app:</p>
<p>In application controller</p>
<p>[code='ruby']<br />
class ApplicationController < ActionController::Base</p>
<p>  before_filter :set_request_environment</p>
<p>private</p>
<p>  # stores parameters for current request<br />
  def set_request_environment<br />
    User.current = current_user # current_user is set by restful_authentication<br />
    # You would also set the time zone for Rails time zone support here:<br />
    # Time.zone = Person.current.time_zone<br />
  end</p>
<p>end<br />
[/code]</p>
<p>In your User model</p>
<p>[code='ruby']<br />
class User < ActiveRecord::Base</p>
<p>  #-----------------------------------------------------------------------------------------------------<br />
  # CLASS METHODS<br />
  #-----------------------------------------------------------------------------------------------------</p>
<p>  def self.current<br />
    Thread.current[:user]<br />
  end</p>
<p>  def self.current=(user)<br />
    raise(ArgumentError,<br />
        "Invalid user. Expected an object of class 'User', got #{user.inspect}") unless user.is_a?(User)<br />
    Thread.current[:user] = user<br />
  end</p>
<p>end<br />
[/code]</p>
<p>There is a danger of abusing this for global variables. They are evil. However I think it is perfectly valid to make the current time zone, the current user, and possibly any other scoping resource globally available. They are like gravity &mdash; they're everywhere, completely pervasive.</p>
<p>And the nice thing is that this also works on the console. Before I manipulate data, I can set Person.current to a user, and will have an audit trail for things I did outside of the running rails app.</p>

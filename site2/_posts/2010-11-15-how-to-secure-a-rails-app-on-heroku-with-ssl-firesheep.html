---
layout: post
title: How to secure a Rails app on heroku with SSL (Firesheep)
date: 2010-11-15 21:10:23.000000000 -08:00
categories:
- Note to self
- Ruby/Rails
tags: []
status: publish
type: post
published: true
meta:
  _syntaxhighlighter_encoded: '1'
  other_media: http://clearcove.ca/wp-content/uploads/2010/11/firesheep_screenshot.png
  main_video: ''
  _edit_last: '1'
  _wp_old_slug: ''
author:
  login: jhund
  email: jhund@clearcove.ca
  display_name: jhund
  first_name: ''
  last_name: ''
excerpt: !ruby/object:Hpricot::Doc
  options: {}
---
<p>The <a href="http://codebutler.com/firesheep">Firesheep</a> Firefox plugin got a lot of attention lately, and rightly so. It raised awareness for the issue of HTTP session hijacking. It's about time we make the internet a more secure place.</p>
<p>I just secured one of our soon to be launched products (<a href="http://tiroapp.com">Tiro</a>) and am documenting the process here. When you follow this tutorial, you will get a Rails app fully secured against HTTP session hijacking as illustrated by the <a href="http://codebutler.com/firesheep">Firesheep</a> Firefox plugin.</p>
<p><!--more--></p>
<p>At the end of this tutorial, you will have:</p>
<ul>
<li>A Rails app that uses SSL for every request (assets included)</li>
<li>Secure Rails and Authlogic authentication cookies that are only transmitted via SSL connections, so they are never sent in plain text</li>
</ul>
<p>For this tutorial, we assume the following conditions:</p>
<ul>
<li>Rails3</li>
<li>hosted on heroku (make sure your app already runs on heroku via http)</li>
<li>using heroku's "Hostname Based Custom SSL" ($20.00 per month, NOTE: works on subdomains only)</li>
<li>all cookies marked as "secure", even the authlogic persistence one</li>
<li>dev machine is OS X, however this is easily transferrable to other OSs</li>
</ul>
<p>This is a pretty long procedure, so let's start with a high level overview:</p>
<ol>
<li>Buy a certificate</li>
<li>Set up the subdomain and certificate on heroku, update DNS</li>
<li>Secure your Rails app by allowing SSL requests only via Rack middleware</li>
<li>Mark Rails session cookies as "secure"</li>
<li>Mark Authlogic persistence cookies as "secure"</li>
</ol>
<p>For this post, I use my.tiroapp.com as an example subdomain. I assume that you want to lock down a single subdomain. Multiple subdomains or a top-level domain require slightly different procedures that are not covered here. So whenever you see my.tiroapp.com here, replace it with your own host name.</p>
<p>Alright, let's start...</p>
<h2>Buy a certificate</h2>
<p>I bought mine for $13 at GoDaddy. To get that deal, simply google for "godaddy ssl". Then click on the ad. This certificate is normally $50, so that's a pretty good deal.</p>
<p>Once you have purchased it, you need to go to your GoDaddy dashboard and generate the certificate with the credit you purchased in the previous step.</p>
<p>When you start the process of generating a certificate, you'll get to a point where the form asks for a CSR (Certificate Signing Request). Here is how to generate one:</p>
<ol>
<li>cd into your Rails app root</li>
<li>
<pre>> mkdir ssl-cert</pre>
</li>
<li>
<pre>> cd ssl-cert</pre>
</li>
<li>
<pre>> openssl genrsa -des3 -out host.key 2048</pre>
</li>
<li>enter and record a passphrase (we will remove it later, but we'll need it again)</li>
<li>
<pre>> openssl req -new -key host.key -out host.csr</pre>
</li>
<li>answer all the questions, but be very careful to use "my.tiroapp.com" under the "organizational unit name" and "common name" fields</li>
</ol>
<p>Here are example answers for the questions:</p>
<pre>
Country Name (2 letter code) [AU]:US
State or Province Name (full name) [Some-State]:California
Locality Name (eg, city) []:Mountain View
Organization Name (eg, company) [Internet Widgits Pty Ltd]: My Company Name
Organizational Unit Name (eg, section) []:my.tiroapp.com
Common Name (eg, YOUR name) []:my.tiroapp.com
Email Address []:contact@tiroapp.com

Please enter the following ‘extra’ attributes
to be sent with your certificate request
A challenge password []:
An optional company name []:

</pre>
<p>.</p>
<p>We have now generated a Certificate Signing Request. Let's use it at GoDaddy:</p>
<ol>
<li>copy the contents of host.csr and paste them into godaddy's form, where they ask for your certificate signing request.</li>
<li>download the certificate from godaddy and unzip the two contained files into the ssl-cert folder in your rails app.</li>
<li>combine the two files: cd into the ssl-cert folder</li>
<li>
<pre>> cat my.tiroapp.com.crt gd_bundle.crt > tiroapp_combined.crt</pre>
</li>
<li>
<pre>> cat my.tiroapp.com.crt host.key > host.pem</pre>
</li>
</ol>
<p>Ok, now we have a certificate. In the next section we will remove the passphrase, as required by Heroku so that they can restart the server. Here you will need the passphrase I asked you to record earlier.</p>
<ol>
<li>cd into the ssl-cert folder in your rails app</li>
<li>
<pre>> openssl rsa -in host.pem -out nopassphrase.pem</pre>
</li>
<li>
<pre>> openssl x509 -in host.pem >>nopassphrase.pem</pre>
</li>
<li>
<pre>> openssl rsa -in host.key -out nopassphrase.key</pre>
</li>
</ol>
<p>With the passphrase removed, we can now set up things at heroku.</p>
<h2>Set up the subdomain and certificate on heroku</h2>
<p>Adding a "Hostname Based Custom SSL" to heroku costs $20 per month. The following commands will trigger that additional charge:</p>
<ol>
<li>cd into the rails root of your application</li>
<li>
<pre>heroku ssl:add ssl-cert/nopassphrase.pem ssl-cert/nopassphrase.key</pre>
</li>
<li>
<pre>heroku addons:add custom_domains:basic</pre>
</li>
<li>
<pre>heroku domains:add my.tiroapp.com</pre>
</li>
<li>
<pre>heroku addons:add ssl:hostname</pre>
</li>
</ol>
<p>Once you are done with this, heroku will email you a CNAME to use for your subdomain. This CNAME has to be used instead of the regular proxy.heroku.com. Go to your DNS provider and create/update the CNAME for my.tiroapp.com. The new CNAME will be similar to:</p>
<pre>appid1234herokucom-56789.us-east-1.elb.amazonaws.com</pre>
<h2>Secure your Rails app</h2>
<p>Now that we have the certificate in place, we want to force all requests (app and assets) to use SSL. Rack is perfectly suited for this purpose:</p>
<p>[ruby]<br />
# lib/middleware/force_ssl.rb<br />
class ForceSSL<br />
  def initialize(app)<br />
    @app = app<br />
  end</p>
<p>  def call(env)<br />
    if env['HTTPS'] == 'on' || env['HTTP_X_FORWARDED_PROTO'] == 'https'<br />
      @app.call(env)<br />
    else<br />
      req = Rack::Request.new(env)<br />
      [301, { &quot;Location&quot; =&gt; req.url.gsub(/^http:/, &quot;https:&quot;) }, []]<br />
    end<br />
  end<br />
end</p>
<p># config/application.rb<br />
config.autoload_paths += %W( #{ config.root }/lib/middleware )</p>
<p># config/environments/production.rb<br />
config.middleware.use &quot;ForceSSL&quot;<br />
[/ruby]</p>
<h2>Mark Rails session cookies as "secure"</h2>
<p>We need to mark cookies as secure in order to prevent the browser from sending them in the clear if a user goes to "http" instead of "https" on your app. Your server will redirect the browser to the "https" URL, however any cookies that are not marked as secure will be transmitted in the clear with the original http request and are thus vulnerable.</p>
<p>[ruby]<br />
# config/initializers/session_store.rb<br />
TiroApp::Application.config.session_store(<br />
  :cookie_store,<br />
  :key =&gt; '_tiro_app_session',<br />
  :secure =&gt; Rails.env.production?, # Only send cookie over SSL when in production mode<br />
  :http_only =&gt; true # Don't allow Javascript to access the cookie (mitigates cookie-based XSS exploits)<br />
)</p>
<p># config/initializers/secret_token.rb<br />
TiroApp::Application.config.secret_token = 'put a really long secret string here...'<br />
[/ruby]</p>
<p>Depending on what authentication library you use, your next steps might vary.</p>
<h2>Mark Authlogic persistence cookies as "secure"</h2>
<p>I use authlogic as authentication library for tiroapp.com. authlogic doesn't mark its session persistence cookies as secure by default. So we will monkey patch it to do so:</p>
<p>[ruby]<br />
# /config/initializers/authlogic_secure_cookie_patch.rb<br />
#<br />
# This patch makes authlogic's persistence cookie<br />
# secure to prevent HTTP session hijacking<br />
module Authlogic<br />
  module Session<br />
    module Cookies<br />
      module InstanceMethods</p>
<p>      private</p>
<p>        def save_cookie<br />
          controller.cookies[cookie_key] = {<br />
            :value =&gt; &quot;#{record.persistence_token}::#{record.send(record.class.primary_key)}&quot;,<br />
            :expires =&gt; remember_me_until,<br />
            :domain =&gt; controller.cookie_domain,<br />
            :secure =&gt; Rails.env.production?, # Only send cookie over SSL when in production mode<br />
            :httponly =&gt; true<br />
          }<br />
        end<br />
      end<br />
    end<br />
  end<br />
end<br />
[/ruby]</p>
<p>Whew, now your app is really secure!</p>
<p>Let me know if I left any security holes open (in regard to session persistence and communications security). Please note that in order to have your app really secure, there are a lot more things to consider. But that's another blog post or two ;-).</p>
<h2>Credits</h2>
<ul>
<li><a href="http://codebutler.com/firesheep">Eric Butler</a> for raising awareness for this issue with his Firesheep plugin</li>
<li><a href="http://jmtame.posterous.com/ssl-certificates-with-godaddy-and-heroku">jmtame</a> for a great walk through through the certificate process. I varied it in a number of places to adapt it to my needs</li>
<li><a href="http://stackoverflow.com/questions/3861772/force-ssl-using-ssl-requirement-in-rails-app/3862679#3862679">Simone Carletti</a> for the ForceSSL rack middleware</li>
<li><a href="http://stackoverflow.com/questions/4147387/how-to-secure-a-rails-app-against-firesheep/4148651#4148651">bioneuralnet</a> for the secure rails session cookie configuration</li>
</ul>
